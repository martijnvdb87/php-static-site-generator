<?php
require __DIR__ . '/vendor/autoload.php';

use Martijnvdb\StaticSiteGenerator\File;
use Martijnvdb\StaticSiteGenerator\Html;
use Martijnvdb\StaticSiteGenerator\Api;
use Martijnvdb\StaticSiteGenerator\Image;
use Martijnvdb\StaticSiteGenerator\Config;
use Martijnvdb\PhpCli\Cli;
use Martijnvdb\PhpCli\Input;
use Martijnvdb\PhpCli\Progress;

$cli = (new Cli('Static site generator', '0.1.0'))
    ->add(function ($input, $output) {
        if(is_null(Config::get('url'))) {
            $url_value = Input::text('[yellow]Site url[/yellow]:')
                ->required()
                ->get();
            
            Config::set('url', $url_value);
        }

        Config::save();

        $GLOBALS['progress'] = Progress::new();
        $GLOBALS['progress']->start();
        
        // Reset public directory
        File::resetPublicDir();

        // Build HTML files
        Html::create()->build();

        $GLOBALS['progress']->set(0.1);
        
        // Build API files
        Api::create()->build();
        
        $GLOBALS['progress']->set(0.2);

        // Build all 
        $images = Image::all();

        $image_progress_part = (0.8 / count($images));

        $progress = 0.2;

        foreach($images as $image) {
            $image->build();
            $progress += $image_progress_part;
            $GLOBALS['progress']->set($progress);
        }
        
        $GLOBALS['progress']->set(1);
        $GLOBALS['progress']->stop();
    })
    ->run();
